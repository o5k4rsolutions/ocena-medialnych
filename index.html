<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Oceniania Medialnych</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --neon-purple: #9c27b0;
            --neon-glow: 0 0 8px rgba(156, 39, 176, 0.9), 0 0 15px rgba(156, 39, 176, 0.6);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
            color: #1f2937; 
        }

        .card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); 
        }
        
        .neon-border {
            border: 2px solid var(--neon-purple);
            box-shadow: var(--neon-glow), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .neon-text {
            color: var(--neon-purple); 
            text-shadow: var(--neon-glow);
        }

        input[type="text"], input[type="url"], textarea, input[type="password"] {
            background-color: #ffffff !important;
            border-color: #cbd5e1 !important;
            color: #1f2937 !important;
            border-radius: 4px; 
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        input:focus, textarea:focus {
            border-color: var(--neon-purple) !important; 
            box-shadow: 0 0 0 1px var(--neon-purple), 0 0 5px rgba(156, 39, 176, 0.5) !important;
        }

        .neon-btn {
            background-color: var(--neon-purple);
            color: white;
            box-shadow: var(--neon-glow);
            transition: all 0.2s ease;
        }
        .neon-btn:hover {
            background-color: #ab47bc;
            box-shadow: 0 0 10px var(--neon-purple), 0 0 20px rgba(156, 39, 176, 0.8);
        }

        .rating-entry {
            border-left: 3px solid var(--neon-purple); 
            padding-left: 1rem;
        }

        .star-rating .star {
            color: #ccc; 
            text-shadow: 0 0 1px #888;
            cursor: pointer;
            transition: color 0.2s, transform 0.1s;
        }
        
        .star-rating .star.selected {
            color: #ffc107; 
            text-shadow: 0 0 3px rgba(255, 193, 7, 0.5), 0 0 6px #ffc107;
        }
        
        .star-rating .star:hover {
            transform: scale(1.1);
            color: #ffc107;
        }
        
        .star-rating .star:hover ~ .star:not(.selected) {
             color: #ccc;
             transform: none;
             text-shadow: 0 0 1px #888;
        }

    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-extrabold mb-2 neon-text">Ocena Medialnych</h1>
            <p class="text-gray-600">NR. 1 W PL Sprawdziany i Kartkówki NIZE</p>
        </header>

        <div id="login-card" class="card p-6 rounded-lg mb-10 neon-border">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2 text-gray-800">Sekcja Administratora: Logowanie</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="admin-login" class="block text-sm font-medium text-gray-700 mb-1">Login</label>
                    <input type="text" id="admin-login" required placeholder="Wpisz login administratora" class="w-full p-3">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Hasło</label>
                    <input type="password" id="admin-password" required placeholder="Wpisz hasło" class="w-full p-3">
                </div>
                <button type="submit" class="w-full neon-btn font-bold py-3 px-4 rounded-md">
                    Zaloguj się
                </button>
            </form>
            <p id="login-message" class="text-center mt-3 text-red-600 hidden">Nieprawidłowy login lub hasło.</p>
        </div>

        <div id="add-personality-card" class="card p-6 rounded-lg mb-10 hidden neon-border">
            <div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-4">
                 <h2 class="text-2xl font-semibold text-gray-800">Dodaj Nową Osobę (Zalogowano)</h2>
                 <button onclick="logoutAdmin()" class="text-sm text-red-600 hover:text-red-800 transition">Wyloguj</button>
            </div>
            
            <form id="add-personality-form" class="space-y-4">
                <div>
                    <label for="discord-nick" class="block text-sm font-medium text-gray-700 mb-1">Nick Discord</label>
                    <input type="text" id="discord-nick" required placeholder="np. UżytkownikFirmowy" class="w-full p-3">
                </div>
                <div>
                    <label for="tiktok-link" class="block text-sm font-medium text-gray-700 mb-1">Link do TikToka (URL)</label>
                    <input type="url" id="tiktok-link" required placeholder="np. https://tiktok.com/@profilfirmowy" class="w-full p-3">
                </div>
                <button type="submit" id="add-button" class="w-full neon-btn font-bold py-3 px-4 rounded-md">
                    Dodaj Osobę
                </button>
            </form>
        </div>

        <div class="card p-6 rounded-lg">
            <h2 class="text-2xl font-semibold mb-4 border-b border-gray-200 pb-2 text-gray-800">Lista Ocenianych</h2>
            <div id="loading" class="text-center py-8 text-gray-500">
                Ładowanie danych...
            </div>
            <div id="personalities-list" class="space-y-6">
            </div>
            <p id="no-personalities" class="text-center py-8 text-gray-500 hidden">
                Brak dodanych osób. Dodaj pierwszą osobę po zalogowaniu!
            </p>
        </div>
        
        <div class="mt-8 p-4 bg-white border border-gray-300 border-l-4 rounded-md shadow-sm" style="border-left-color: var(--neon-purple);">
            <p class="font-bold text-gray-700">Twój ID Użytkownika:</p>
            <p id="user-id-display" class="font-mono text-sm break-all text-gray-500"></p>
        </div>

    </div>

    <div id="history-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto p-6 border border-gray-200">
            <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 border-b-2" style="border-bottom-color: var(--neon-purple);">Historia Ocen</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-content" class="space-y-4">
                <p class="text-center text-gray-500">Ładowanie historii...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, query, addDoc, serverTimestamp, setLogLevel, orderBy, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        const encodedLogin = 'TklaeQ9kdmW1wMjM=';
        const encodedPassword = 'QWRtaW5OaXp1Njk=';

        const decodeBase64 = (str) => {
            if (str === 'TklaeQ9kdmW1wMjM=') return 'NizeAdmin123';
            if (str === 'QWRtaW5OaXp1Njk=') return 'AdminNize69';
            return '';
        };

        const ADMIN_LOGIN = decodeBase64(encodedLogin);
        const ADMIN_PASSWORD = decodeBase64(encodedPassword);
        let isAdminLoggedIn = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const externalFirebaseConfig = {
             apiKey: "AIzaSyAAeQbCXt15Zjuf_sA1p0jRp_tSb8WSaNs",
             authDomain: "ocena-medialnych.firebaseapp.com",
             projectId: "ocena-medialnych",
             storageBucket: "ocena-medialnych.firebasestorage.app",
             messagingSenderId: "570287989991",
             appId: "1:570287989991:web:4c0594ab280515802dee42"
        };
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
            ? JSON.parse(__firebase_config)
            : externalFirebaseConfig;

        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "") {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Zalogowano z custom tokenem.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Zalogowano anonimowo.");
                    }
                } catch (error) {
                    console.error("Błąd autentykacji:", error);
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Stan autentykacji gotowy. User ID:", userId);
                    document.getElementById('user-id-display').textContent = userId;
                    loadPersonalities();
                } else {
                    userId = null;
                    isAuthReady = true;
                    console.log("Autentykacja nie powiodła się lub użytkownik wylogowany. Nie wczytano prywatnych danych.");
                    document.getElementById('user-id-display').textContent = 'Błąd autentykacji. Brak ID.';
                    document.getElementById('loading').textContent = 'Wymagane uprawnienia. Błąd autentykacji.';
                }
            });

            authenticate();
        } else {
            console.error("Błąd: Brak konfiguracji Firebase. Uzupełnij externalFirebaseConfig.");
            document.getElementById('loading').textContent = 'BŁĄD: Brak kluczy Firebase. Wklej konfigurację do pliku HTML, aby uruchomić na GitHubie.';
        }

        const loginForm = document.getElementById('login-form');
        const loginCard = document.getElementById('login-card');
        const addCard = document.getElementById('add-personality-card');
        const loginMessage = document.getElementById('login-message');

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const login = document.getElementById('admin-login').value.trim();
            const password = document.getElementById('admin-password').value.trim();

            if (login === ADMIN_LOGIN && password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                loginCard.classList.add('hidden');
                addCard.classList.remove('hidden');
                loginMessage.classList.add('hidden');
                alertUser('Zalogowano jako Administrator!', 'success');
            } else {
                loginMessage.classList.remove('hidden');
                alertUser('Nieprawidłowy login lub hasło.', 'error');
            }
        });

        window.logoutAdmin = () => {
            isAdminLoggedIn = false;
            loginCard.classList.remove('hidden');
            addCard.classList.add('hidden');
            document.getElementById('login-form').reset();
            alertUser('Wylogowano Administratora.', 'info');
        };

        const getPersonalitiesCollectionRef = () => {
            if (!db) throw new Error("Firebase nie jest gotowe.");
            return collection(db, 'artifacts', appId, 'public', 'data', 'media_nicks');
        };

        const getRatingsCollectionRef = (personalityId) => {
            if (!db) throw new Error("Firebase nie jest gotowe.");
            return collection(db, 'artifacts', appId, 'public', 'data', 'media_nicks', personalityId, 'ratings');
        };

        const savePersonality = async (discordNick, tiktokLink) => {
            if (!isAdminLoggedIn) {
                 alertUser('Błąd: Tylko Administrator może dodawać nowe osoby.', 'error');
                 return;
            }
            try {
                const personalitiesRef = getPersonalitiesCollectionRef();
                await addDoc(personalitiesRef, {
                    discordNick: discordNick,
                    tiktokLink: tiktokLink,
                    createdAt: serverTimestamp()
                });
                console.log("Dodano nowy nick:", discordNick);
            } catch (e) {
                console.error("Błąd podczas dodawania nicka: ", e);
                alertUser('Wystąpił błąd podczas dodawania nicka.', 'error');
            }
        };

        const saveRating = async (personalityId, rating, description) => {
            if (!userId) {
                alertUser('Błąd autentykacji. Nie można zapisać oceny.', 'error');
                return;
            }
            try {
                const ratingsRef = getRatingsCollectionRef(personalityId);
                await addDoc(ratingsRef, {
                    rating: rating,
                    description: description,
                    timestamp: serverTimestamp(),
                    raterUserId: userId 
                });

                alertUser(`Ocena (${rating} gwiazdek) z opisem została zapisana!`, 'success');
            } catch (e) {
                console.error("Błąd podczas zapisywania oceny: ", e);
                alertUser('Wystąpił błąd podczas zapisywania oceny.', 'error');
            }
        };
        
        const deleteRatingsCollection = async (personalityId) => {
            const ratingsRef = getRatingsCollectionRef(personalityId);
            const snapshot = await getDocs(ratingsRef);
            
            const batch = writeBatch(db);

            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });

            if (snapshot.size > 0) {
                await batch.commit();
                console.log(`Usunięto ${snapshot.size} ocen dla nicka: ${personalityId}.`);
            } else {
                console.log(`Brak ocen do usunięcia dla nicka: ${personalityId}.`);
            }
        };

        window.deletePersonality = async (personalityId, discordNick) => {
            if (!db) {
                alertUser('Błąd: Brak autoryzacji lub połączenia z bazą danych.', 'error');
                return;
            }
            if (!isAdminLoggedIn) {
                alertUser('Błąd: Tylko Administrator może usuwać osoby. Zaloguj się.', 'error');
                return;
            }
            
            const btn = document.querySelector(`button[onclick*="${personalityId}"][class*="bg-red-700"]`);
            if (btn) btn.disabled = true;

            try {
                await deleteRatingsCollection(personalityId);

                const personalityDocRef = doc(getPersonalitiesCollectionRef(), personalityId);
                await deleteDoc(personalityDocRef);
                
                alertUser(`Nick "${discordNick}" został usunięty pomyślnie!`, 'success');
            } catch (e) {
                console.error("Błąd podczas usuwania nicka: ", e);
                alertUser('Wystąpił błąd podczas usuwania nicka.', 'error');
            } finally {
                if (btn) btn.disabled = false;
            }
        };

        const handleStarClick = (event, personalityId) => {
            const star = event.target;
            const ratingValue = parseInt(star.dataset.value);
            const container = document.getElementById(`personality-${personalityId}`);
            const stars = container.querySelectorAll('.star');
            const saveBtn = container.querySelector('.save-rating-btn');
            
            stars.forEach((s) => {
                const sValue = parseInt(s.dataset.value);
                if (sValue <= ratingValue) {
                    s.classList.add('selected');
                } else {
                    s.classList.remove('selected');
                }
            });

            saveBtn.dataset.rating = ratingValue;
            saveBtn.disabled = false;
        };


        const renderPersonalityItem = (personality, ratings) => {
            const { id, discordNick, tiktokLink } = personality;
            const container = document.createElement('div');
            container.id = `personality-${id}`;
            container.className = 'card bg-white p-5 border border-gray-300 rounded-lg shadow-sm hover:border-9c27b0 transition duration-300'
            container.style.borderColor = 'var(--neon-purple)';
            

            const totalRating = ratings.reduce((sum, rating) => sum + rating.rating, 0);
            const averageRating = ratings.length > 0 ? (totalRating / ratings.length) : 0;
            const roundedAverage = ratings.length > 0 ? Math.round(averageRating) : 0;
            const ratingCount = ratings.length;

            container.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b border-gray-200 pb-3">
                    <div class="mb-2 md:mb-0">
                        <h3 class="text-2xl font-bold text-gray-800">${discordNick}</h3>
                        <a href="${tiktokLink}" target="_blank" class="text-sm text-blue-600 hover:text-blue-800 transition underline">${tiktokLink}</a>
                    </div>
                    <div class="text-base text-gray-600 font-semibold text-right">
                        ${ratingCount > 0 ? 
                            `<span class="text-gray-700">Średnia:</span> <span class="text-amber-500 font-bold">${'★'.repeat(roundedAverage) + '☆'.repeat(5 - roundedAverage)}</span> (${averageRating.toFixed(1)}/5, ${ratingCount} ocen)` 
                            : 'Brak ocen'}
                    </div>
                </div>

                <div class="flex flex-col gap-5">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <div class="flex-shrink-0">
                            <span class="font-medium text-gray-700 block mb-2">Oceń dzisiaj:</span>
                            <div class="star-rating flex text-3xl" data-id="${id}">
                                ${[1, 2, 3, 4, 5].map(i => `
                                    <span class="star" data-value="${i}">★</span>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex-grow w-full">
                            <label for="description-${id}" class="block text-sm font-medium text-gray-700 mb-1">Opis (opcjonalnie):</label>
                            <textarea id="description-${id}" rows="2" placeholder="Wpisz krótki komentarz, np. 'Bardzo ciekawy ostatni film'." class="w-full p-3 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:items-center justify-end gap-3">
                        <button data-id="${id}" class="save-rating-btn neon-btn bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 transition duration-150 shadow-sm flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Zapisz Ocenę
                        </button>
                        <button onclick="showHistory('${id}', '${discordNick}')" class="neon-btn text-white font-medium py-2 px-4 rounded-md transition duration-150 shadow-sm flex items-center justify-center w-full sm:w-auto">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            Historia Ocen (${ratings.length})
                        </button>
                        <button onclick="deletePersonality('${id}', '${discordNick}')" class="bg-red-700 text-white font-medium py-2 px-4 rounded-md hover:bg-red-800 transition duration-150 shadow-sm flex items-center justify-center w-full sm:w-auto">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Usuń
                        </button>
                    </div>
                </div>
            `;

            const saveBtn = container.querySelector('.save-rating-btn');
            const starContainer = container.querySelector('.star-rating');
            const descriptionInput = container.querySelector(`#description-${id}`);
            
            saveBtn.disabled = true;

            starContainer.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', (e) => handleStarClick(e, id));
            });

            saveBtn.addEventListener('click', () => {
                const rating = parseInt(saveBtn.dataset.rating);
                const description = descriptionInput.value.trim();
                
                if (rating >= 1 && rating <= 5) {
                    saveRating(id, rating, description);
                    starContainer.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
                    descriptionInput.value = '';
                    saveBtn.dataset.rating = null;
                    saveBtn.disabled = true;
                } else {
                    alertUser('Wybierz liczbę gwiazdek przed zapisem.', 'warning');
                }
            });

            return container;
        };

        const loadPersonalities = () => {
            if (!isAuthReady) {
                return;
            }

            const personalitiesRef = getPersonalitiesCollectionRef();
            const listContainer = document.getElementById('personalities-list');
            const loadingElement = document.getElementById('loading');
            const noPersonalitiesElement = document.getElementById('no-personalities');

            listContainer.innerHTML = '';
            loadingElement.classList.remove('hidden');

            onSnapshot(personalitiesRef, (snapshot) => {
                loadingElement.classList.add('hidden');
                const personalitiesData = [];
                snapshot.forEach(doc => {
                    personalitiesData.push({ id: doc.id, ...doc.data() });
                });

                if (personalitiesData.length === 0) {
                    listContainer.innerHTML = '';
                    noPersonalitiesElement.classList.remove('hidden');
                } else {
                    noPersonalitiesElement.classList.add('hidden');

                    const activeRatingSubscriptions = new Set();
                    
                    personalitiesData.forEach(personality => {
                        if (activeRatingSubscriptions.has(personality.id)) return;
                        activeRatingSubscriptions.add(personality.id);

                        const ratingsRef = query(getRatingsCollectionRef(personality.id));
                        onSnapshot(ratingsRef, (ratingsSnapshot) => {
                            const ratings = [];
                            ratingsSnapshot.forEach(ratingDoc => {
                                ratings.push({ id: ratingDoc.id, ...ratingDoc.data() });
                            });

                            let itemContainer = document.getElementById(`personality-${personality.id}`);
                            if (itemContainer) {
                                itemContainer.remove();
                            }
                            const newItem = renderPersonalityItem(personality, ratings);
                            listContainer.appendChild(newItem);
                        }, (error) => {
                            console.error("Błąd ładowania ocen dla", personality.discordNick, ":", error);
                        });
                    });
                }
            }, (error) => {
                console.error("Błąd ładowania nicków:", error);
                loadingElement.textContent = error.code === 'permission-denied'
                    ? 'BŁĄD UPRAWNIEŃ: Zaktualizuj Reguły Bezpieczeństwa w konsoli Firebase, aby umożliwić dostęp publiczny do ścieżki /public/data.'
                    : `Błąd ładowania danych: ${error.message}`;
                loadingElement.classList.remove('hidden');
            });
        };

        document.getElementById('add-personality-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const discordNick = document.getElementById('discord-nick').value.trim();
            const tiktokLink = document.getElementById('tiktok-link').value.trim();

            if (discordNick && tiktokLink) {
                document.getElementById('add-button').textContent = 'Dodawanie...';
                document.getElementById('add-button').disabled = true;
                await savePersonality(discordNick, tiktokLink);
                document.getElementById('add-button').textContent = 'Dodaj Osobę';
                document.getElementById('add-button').disabled = false;
                if (isAdminLoggedIn) {
                   document.getElementById('add-personality-form').reset();
                }
            } else {
                alertUser('Wypełnij oba pola!', 'warning');
            }
        });

        window.showHistory = (personalityId, discordNick) => {
            const modal = document.getElementById('history-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            modalTitle.textContent = `Historia Ocen: ${discordNick}`;
            modalContent.innerHTML = '<p class="text-center text-gray-500">Ładowanie historii...</p>';
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            const ratingsRef = query(getRatingsCollectionRef(personalityId), orderBy('timestamp', 'desc'));

            const unsubscribe = onSnapshot(ratingsRef, (snapshot) => {
                const ratings = [];
                snapshot.forEach(doc => {
                    ratings.push({ id: doc.id, ...doc.data() });
                });

                if (ratings.length === 0) {
                    modalContent.innerHTML = '<p class="text-center text-gray-500">Brak zapisanych ocen.</p>';
                    return;
                }

                modalContent.innerHTML = '';
                ratings.forEach(rating => {
                    const date = rating.timestamp ? rating.timestamp.toDate() : new Date();
                    const formattedDate = date.toLocaleString('pl-PL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });

                    const stars = '★'.repeat(rating.rating) + '☆'.repeat(5 - rating.rating);
                    const rater = rating.raterUserId ? `Oceniono przez: ${rating.raterUserId}` : 'Oceniono anonimowo';

                    const entry = document.createElement('div');
                    entry.className = 'rating-entry bg-white p-4 rounded-md flex flex-col space-y-2 border border-gray-200';
                    entry.innerHTML = `
                        <div class="flex justify-between items-start">
                            <span class="text-2xl font-bold text-amber-500">${stars}</span>
                            <div class="text-right">
                                <p class="text-sm font-medium text-gray-700">Ocena: ${rating.rating}/5</p>
                                <p class="text-xs text-gray-500">${formattedDate}</p>
                            </div>
                        </div>
                        ${rating.description ? 
                            `<div class="mt-2 p-2 bg-gray-50 rounded-md border border-gray-200">
                                <p class="text-xs font-semibold text-gray-600">Opis:</p>
                                <p class="text-sm text-gray-800 whitespace-pre-wrap">${rating.description}</p>
                            </div>` 
                            : ''}
                        <p class="text-xs text-purple-700 font-mono mt-1 break-all">${rater}</p>
                    `;
                    modalContent.appendChild(entry);
                });

            }, (error) => {
                console.error("Błąd ładowania historii:", error);
                modalContent.innerHTML = '<p class="text-center text-red-600">Błąd ładowania historii.</p>';
            });

            modal.dataset.unsubscribe = unsubscribe;
        };

        window.closeModal = () => {
            const modal = document.getElementById('history-modal');
            const unsubscribe = modal.dataset.unsubscribe;
            if (unsubscribe && typeof unsubscribe === 'function') {
                unsubscribe();
            }
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
        
        const alertUser = (message, type = 'info') => {
            const colors = {
                success: 'bg-green-600 shadow-lg',
                error: 'bg-red-600 shadow-lg',
                warning: 'bg-yellow-600 shadow-lg',
                info: 'bg-blue-600 shadow-lg'
            };

            const notification = document.createElement('div');
            notification.className = `${colors[type]} text-white p-3 rounded-md shadow-xl fixed bottom-4 right-4 z-[9999] transition-all transform duration-300 translate-x-0 opacity-100`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-full');
                notification.addEventListener('transitionend', () => notification.remove());
            }, 3000);
        };
    </script>
</body>
</html>
